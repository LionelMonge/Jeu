<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>GameJam - In the matrice</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var MAX_LENGTH = 10;
    var MIN_LENGTH = 4;

    function Bar(column){
        console.log('generating bar at column: ' + column);
        this.length = 0;
        this.speed = 0;
        this.group = undefined;
        this.column = column;
        this.canBeBugged = false;//not used anymore
        this.buggedStep = -1;


        //itnernal
        this.timer = 0;
        this.steps = 0;
        this.generate = function() {
            var canBeBugged = game.rnd.between(0,30);
            if(canBeBugged == 0){
                this.buggedStep = -1;
            } else {
                this.buggedStep = canBeBugged;
            }
            this.speed = game.rnd.between(30,35);
            this.length = game.rnd.between(MIN_LENGTH, MAX_LENGTH);
            if (typeof this.group !== "undefined") {
                console.log("Found defined group:" + this.column);
                this.group = undefined;
            }


            this.group = game.add.group();
            this.group.y = 10;
            for(var i=0;i<this.length;i++){
                this.group.create(1, i * 30, 'matrixfont',game.rnd.between(1,80));
            }
            this.group.setAllChildren('tint', '0x008800');
            this.group.getChildAt(this.length-1).tint = '0xFFFFFF';
            this.group.getChildAt(0).tint = "0X003300";
            this.group.getChildAt(1).tint = "0X006600";
        }

        this.redify = function(){
            this.group.setAllChildren('tint','0xff0000');
            /*for(var i=0;i<this.length;i++) {
                var tweenA = game.add.tween(this.group.getChildAt(i).scale).to({x: 3,y:3}, 2000, Phaser.Easing.Linear.None);
                var tweenB = game.add.tween(this.group.getChildAt(i).scale).to({x:1, y:1}, 2000, Phaser.Easing.Linear.None);
                tweenA.chain(tweenB);
            }*/
            //var tweenA = game.add.tween(this.group.scale).to({x: 1.5,y:1.5}, 200, Phaser.Easing.Linear.None);
            var tweenB = game.add.tween(this.group.scale).to({x:1, y:1}, 200, Phaser.Easing.Linear.None);
            tweenA.chain(tweenB);

            tweenA.start();


        }
        this.checkUpdate = function(){
            this.steps++;
            if(this.buggedStep != -1){
                this.buggedStep--;
                if(this.buggedStep == 0) {
                    this.redify();
                }
            }
        }
    }
    var timer =0;

    var game = new Phaser.Game(1280, 720, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update });

    var barre = [];
    var v_barre = [];
    var t_barre = [];

    function preload() {

        //game.load.spritesheet('block', 'pics/block.jpeg',20,20);
        game.load.spritesheet('matrixfont', 'assets/pics/matrix.png', 38, 40, 93);

    }

    function create() {
        game.time.advancedTiming = true;
        game.time.desiredFps = 30;
        game.time.slowMotion = 1.0;

        game.time.desiredFps = 60;
        game.time.fpsMax = 60;
        game.time.fpsMin = 40;
//        this.game.stage.backgroundColor = '#FFFFFF';
//        for(var l = 0; l < 9; l++) {
//            for(var c = 0; c < 10; c++) {
//                    game.add.sprite((c * 45) + 10, (l * 45) + 10, 'matrixfont', (l * 10) + (c+1));
//            }
//        }



        for(var i=0;i<30;i++){
            barre[i] = new Bar(i);
            barre[i].generate();
            barre[i].group.x = 10+(i*38);
            barre[i].group.y = 10;
        }
    }
        /*for(var n=0; n<30; n++) {

            barre[n]=game.add.group();
            t_barre[n] = game.rnd.between(5,30);

            for(var i = 0; i < t_barre[n]; i++) {
                barre[n].create(1, i * 30, 'matrixfont',game.rnd.between(1,80));
            }
            v_barre[n] = 30 * game.rnd.between(1,3);
            barre[n].setAllChildren('tint', '0x008800');
            barre[n].x = 10+(n*38);
            barre[n].y = -t_barre[n];
        }

    }*/

    function update() {
            for(var i=0;i< barre.length;i++){
                if(barre[i].timer == barre[i].speed){
                    barre[i].checkUpdate();
                    barre[i].group.y += 30;
                    barre[i].timer = 0;
                } else {
                    barre[i].timer++;
                }
            }

    /*timer++;
    if(timer==15) {
        for(var n = 0; n < 30; n++) {
            if (barre[n].y > game.height + (t_barre[n]*30)) {
                barre[n].y = -(t_barre[n]*30);
                //console.log(-t_barre[n]);
                v_barre[n] = 30 * game.rnd.between(1,3);
            }
            barre[n].y += v_barre[n];
        }
        timer=0;
    }*/
   }

</script>

</body>
</html>